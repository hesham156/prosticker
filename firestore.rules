rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check user role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read users (for employee lists)
      allow read: if isAuthenticated();
      
      // Only authenticated users can create/update
      // In production, restrict this to admins only
      allow create, update: if isAuthenticated();
      
      // Only admins should be able to delete (implement backend function)
      allow delete: if isAuthenticated();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // All authenticated users can read orders
      allow read: if isAuthenticated();
      
      // Sales users can create orders
      allow create: if isAuthenticated() && hasRole('sales');
      
      // Design and Production users can update orders
      allow update: if isAuthenticated() && 
                      (hasRole('design') || hasRole('production') || hasRole('admin'));
      
      // Only admins can delete orders
      allow delete: if isAuthenticated() && hasRole('admin');
    }
  }
}
