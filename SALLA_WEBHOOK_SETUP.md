# دليل إعداد Webhook من سلة

## نظرة عامة

هذا الدليل يشرح كيفية ربط متجرك في سلة مع نظام إدارة الطباعة لاستقبال الطلبات المؤكدة تلقائياً.

## الخطوة 1: الحصول على API Key

استخدم نفس الـ API Key المستخدم في Vercel:
```
sk_live_abc123xyz456
```

## الخطوة 2: إعداد Webhook في لوحة تحكم سلة

1. **تسجيل الدخول إلى حساب المطور في سلة:**
   - اذهب إلى: [https://salla.dev](https://salla.dev)
   - سجل دخول بحساب المتجر

2. **إنشاء تطبيق جديد (إذا لم يكن موجود):**
   - اذهب إلى **My Apps**
   - اضغط **Create App**
   - املأ البيانات المطلوبة

3. **إضافة Webhook URL:**
   - اذهب إلى تفاصيل التطبيق
   - اضغط على **Webhooks**
   - اضغط **Add Webhook**
   - أدخل الـ URL التالي:
   ```
   https://prosticker.vercel.app/api/webhook?apiKey=sk_live_abc123xyz456
   ```

4. **اختيار الأحداث (Events):**
   
   اختر الأحداث التالية فقط:
   - ✅ `order.created` - عند إنشاء طلب جديد
   - ✅ `order.status.updated` - عند تحديث حالة الطلب
   
   > **ملاحظة:** النظام سيقوم تلقائياً بفلترة الطلبات ولن يُنشئ إلا الطلبات المؤكدة (غير المسودات والمعلقة).

5. **حفظ الإعدادات:**
   - اضغط **Save**
   - تأكد من تفعيل الـ Webhook

## الخطوة 3: تكوين المنتجات في سلة

### لضمان تحديد نوع المنتج بشكل صحيح:

أضف في **اسم المنتج** أو **SKU** كلمات مفتاحية من القائمة التالية:

| نوع المنتج | الكلمات المفتاحية بالإنجليزية | الكلمات المفتاحية بالعربية |
|------------|-------------------------------|---------------------------|
| Ribbons    | ribbon                         | شريط                      |
| Belts      | belt                           | حزام                      |
| Stickers   | sticker                        | استيكر، ملصق              |

**أمثلة:**
- ✅ اسم المنتج: "Custom Ribbon - White Satin" → سيتم تصنيفه كـ ribbons
- ✅ SKU: "BELT-001" → سيتم تصنيفه كـ belts
- ✅ اسم المنتج: "ملصقات مخصصة" → سيتم تصنيفه كـ stickers
- ⚠️ اسم المنتج: "طباعة مخصصة" → سيتم تصنيفه كـ custom (افتراضي)

## الخطوة 4: اختبار التكامل

### اختبار 1: إنشاء طلب تجريبي

1. اذهب إلى متجرك في سلة
2. أضف منتج إلى السلة
3. أكمل عملية الشراء
4. تأكد من أن حالة الطلب **مؤكد** وليس **مسودة**

### اختبار 2: التحقق من الطلب في النظام

1. افتح **Sales Dashboard** في نظام إدارة الطباعة
2. ابحث عن طلب برقم: `SALLA-{reference_id}`
3. تحقق من البيانات:
   - ✅ نوع المنتج صحيح
   - ✅ تاريخ التسليم = تاريخ الطلب + 7 أيام
   - ✅ معلومات العميل موجودة في ملاحظات المبيعات
   - ✅ الحالة: `pending-design`

### اختبار 3: فحص السجلات

تحقق من سجلات الـ webhooks في Firebase:
```
Collection: webhook_logs
```

يجب أن تجد سجل يحتوي على:
- `source: "salla"`
- `event: "order.created"`
- `merchant: {merchant_id}`
- `status: "success"`

## استكشاف الأخطاء

### المشكلة: لا تصل الطلبات إلى النظام

**الحلول:**
1. تأكد من صحة الـ API Key في URL
2. تأكد من تفعيل الـ Webhook في لوحة تحكم سلة
3. تحقق من أن الطلب **مؤكد** وليس مسودة
4. راجع سجلات الـ webhooks في Firebase للتفاصيل

### المشكلة: نوع المنتج يظهر "custom" دائماً

**الحل:**
- أضف كلمة مفتاحية من الجدول أعلاه في اسم المنتج أو SKU

### المشكلة: تاريخ التسليم غير صحيح

**ملاحظة:**
- النظام يحسب تلقائياً: تاريخ الطلب + 7 أيام
- يمكن تعديل التاريخ يدوياً من لوحة المبيعات إذا لزم الأمر

## البيانات التي يتم جمعها من سلة

عند استقبال طلب من سلة، يتم حفظ البيانات التالية:

| الحقل | المصدر من سلة |
|-------|---------------|
| Order Number | `SALLA-{reference_id}` |
| Product Type | مستخرج من اسم المنتج/SKU |
| Quantity | مجموع كميات العناصر |
| Delivery Date | تاريخ الطلب + 7 أيام |
| Customer Info | معلومات العميل (الاسم، الجوال، البريد) |
| Order Total | المبلغ الإجمالي بالعملة |
| Payment Method | طريقة الدفع |
| Items | قائمة العناصر بالتفاصيل |

## ملاحظات مهمة

> [!IMPORTANT]
> - الطلبات المسودة (**draft**) لن يتم إنشاؤها في النظام
> - فقط الطلبات المؤكدة ستُنشأ تلقائياً
> - يتم تسجيل جميع الأحداث في `webhook_logs` حتى لو لم يتم إنشاء طلب

> [!TIP]
> - يمكنك تخصيص مدة التنفيذ الافتراضية عن طريق تعديل الكود إذا لزم الأمر
> - يمكن إضافة المزيد من أنواع المنتجات بتعديل دالة `extractProductType`

## الدعم

في حالة وجود مشاكل:
1. راجع سجلات Vercel: [https://vercel.com/dashboard](https://vercel.com/dashboard)
2. راجع `webhook_logs` في Firebase
3. تأكد من صحة تكوين المنتجات في سلة
